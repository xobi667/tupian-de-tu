<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xobi AI Chat - Ant Design X</title>

    <!-- Ant Design CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.0/dist/reset.css">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Ant Design & Ant Design X -->
    <script src="https://cdn.jsdelivr.net/npm/antd@5.12.0/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ant-design/x@1.0.0-beta.14/dist/antd-x.min.js"></script>

    <!-- Config Manager -->
    <script src="assets/js/config-manager.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #root {
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .app-layout {
            height: 100%;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
        }

        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 24px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header {
            margin-bottom: 32px;
        }

        .sidebar-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .upload-section {
            margin-bottom: 24px;
        }

        .upload-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #fafafa;
        }

        .chat-header {
            padding: 20px 24px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }

        .chat-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .chat-input-area {
            padding: 20px 24px;
            background: white;
            border-top: 1px solid #f0f0f0;
        }

        .preview-panel {
            background: white;
            border-left: 1px solid #f0f0f0;
            padding: 24px;
            overflow-y: auto;
        }

        .preview-header {
            margin-bottom: 20px;
        }

        .preview-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 8px;
        }

        .preview-image {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .platform-selector {
            margin-top: 20px;
        }

        .platform-selector h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #666;
        }

        /* Ant Design X Customization */
        .ant-bubble {
            max-width: 80%;
        }

        .ant-bubble-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .ant-prompts-item {
            border-radius: 12px;
            transition: all 0.3s;
        }

        .ant-prompts-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Loading Animation */
        .thinking-dots {
            display: inline-block;
        }

        .thinking-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: thinking 1.4s infinite;
        }

        .thinking-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const {
            Upload,
            Button,
            Input,
            Space,
            Card,
            Badge,
            Spin,
            message,
            Select,
            Typography,
            Divider,
            Tag
        } = antd;
        const { Bubble, Prompts, Sender, Attachments, Welcome } = window['@ant-design/x'];

        const { Title, Text, Paragraph } = Typography;

        function XobiChatApp() {
            const [chatHistory, setChatHistory] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [loading, setLoading] = useState(false);
            const [refImage, setRefImage] = useState(null);
            const [prodImage, setProdImage] = useState(null);
            const [resultImage, setResultImage] = useState(null);
            const [selectedPlatform, setSelectedPlatform] = useState('amazon');
            const messagesEndRef = useRef(null);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [chatHistory]);

            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            const handleImageUpload = (type) => (info) => {
                if (info.file.status === 'done') {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (type === 'ref') setRefImage(e.target.result);
                        else if (type === 'prod') setProdImage(e.target.result);
                    };
                    reader.readAsDataURL(info.file.originFileObj);
                }
            };

            // å‘é€æ¶ˆæ¯
            const handleSend = async (value) => {
                if (!value.trim() && !loading) return;

                const userMessage = {
                    role: 'user',
                    content: value,
                    timestamp: new Date().toISOString()
                };

                setChatHistory(prev => [...prev, userMessage]);
                setInputValue('');
                setLoading(true);

                try {
                    // è°ƒç”¨åç«¯ API
                    const response = await fetch('/api/smart-chat/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: value,
                            history: chatHistory,
                            context: {
                                platform: selectedPlatform,
                                hasRefImage: !!refImage,
                                hasProdImage: !!prodImage
                            }
                        })
                    });

                    const data = await response.json();

                    const aiMessage = {
                        role: 'assistant',
                        content: data.response,
                        suggestions: data.suggestions,
                        timestamp: new Date().toISOString()
                    };

                    setChatHistory(prev => [...prev, aiMessage]);

                    // å¦‚æœ AI è§¦å‘äº†ç”ŸæˆåŠ¨ä½œ
                    if (data.action === 'generate') {
                        message.success('å¼€å§‹ç”Ÿæˆå›¾ç‰‡...');
                        // TODO: è°ƒç”¨ç”Ÿæˆ API
                    }

                } catch (error) {
                    message.error('AI å“åº”å¤±è´¥ï¼Œè¯·é‡è¯•');
                    console.error('Chat error:', error);
                } finally {
                    setLoading(false);
                }
            };

            // é¢„è®¾æç¤ºè¯
            const promptSuggestions = [
                {
                    key: '1',
                    label: 'ç®€çº¦ç™½åº•',
                    description: 'çº¯ç™½èƒŒæ™¯ï¼Œäº§å“å±…ä¸­ï¼Œä¸“ä¸šå•†ä¸šæ‘„å½±',
                    icon: 'ğŸ¨'
                },
                {
                    key: '2',
                    label: 'æ¸©é¦¨å®¶å±…åœºæ™¯',
                    description: 'æ¸©æš–çš„å®¶å±…ç¯å¢ƒï¼Œè‡ªç„¶å…‰çº¿',
                    icon: 'ğŸ '
                },
                {
                    key: '3',
                    label: 'ç§‘æŠ€æ„Ÿæ¸å˜',
                    description: 'æœªæ¥ç§‘æŠ€é£æ ¼ï¼Œæ¸å˜èƒŒæ™¯',
                    icon: 'ğŸš€'
                },
                {
                    key: '4',
                    label: 'å¤æ—¥æ¸…å‡‰',
                    description: 'æ°´èŠ±é£æº…ï¼Œæ¸…æ–°è§†è§‰',
                    icon: 'ğŸ’§'
                }
            ];

            const handlePromptClick = (prompt) => {
                setInputValue(prompt.description);
            };

            return (
                <div className="app-layout">
                    {/* å·¦ä¾§è¾¹æ  - å›¾ç‰‡ä¸Šä¼  */}
                    <div className="sidebar">
                        <div className="sidebar-header">
                            <h1>âš¡ Xobi AI</h1>
                            <p>æ™ºèƒ½ç”µå•†å›¾ç‰‡ç”Ÿæˆ</p>
                        </div>

                        <div className="upload-section">
                            <label className="upload-label">ğŸ“· å‚è€ƒå›¾</label>
                            <Upload
                                accept="image/*"
                                showUploadList={false}
                                customRequest={({ file, onSuccess }) => {
                                    setTimeout(() => onSuccess("ok"), 0);
                                }}
                                onChange={handleImageUpload('ref')}
                            >
                                <Button
                                    type="dashed"
                                    block
                                    size="large"
                                    style={{ height: 120 }}
                                >
                                    {refImage ? (
                                        <img src={refImage} alt="å‚è€ƒå›¾" style={{ width: '100%', height: '100%', objectFit: 'cover', borderRadius: 8 }} />
                                    ) : (
                                        <div>
                                            <div style={{ fontSize: 32, marginBottom: 8 }}>ğŸ–¼ï¸</div>
                                            <div>ç‚¹å‡»ä¸Šä¼ å‚è€ƒå›¾</div>
                                        </div>
                                    )}
                                </Button>
                            </Upload>
                        </div>

                        <div className="upload-section">
                            <label className="upload-label">ğŸ“¦ äº§å“å›¾</label>
                            <Upload
                                accept="image/*"
                                showUploadList={false}
                                customRequest={({ file, onSuccess }) => {
                                    setTimeout(() => onSuccess("ok"), 0);
                                }}
                                onChange={handleImageUpload('prod')}
                            >
                                <Button
                                    type="dashed"
                                    block
                                    size="large"
                                    style={{ height: 120 }}
                                >
                                    {prodImage ? (
                                        <img src={prodImage} alt="äº§å“å›¾" style={{ width: '100%', height: '100%', objectFit: 'cover', borderRadius: 8 }} />
                                    ) : (
                                        <div>
                                            <div style={{ fontSize: 32, marginBottom: 8 }}>ğŸ›ï¸</div>
                                            <div>ç‚¹å‡»ä¸Šä¼ äº§å“å›¾</div>
                                        </div>
                                    )}
                                </Button>
                            </Upload>
                        </div>

                        <Divider style={{ borderColor: 'rgba(255,255,255,0.1)' }} />

                        <div style={{ marginTop: 20 }}>
                            <Text style={{ color: 'rgba(255,255,255,0.6)', fontSize: 12 }}>
                                ğŸ’¡ Tip: å…ˆä¸Šä¼ å›¾ç‰‡ï¼Œç„¶ååœ¨èŠå¤©ä¸­æè¿°éœ€æ±‚
                            </Text>
                        </div>
                    </div>

                    {/* ä¸­é—´ - èŠå¤©åŒºåŸŸ */}
                    <div className="chat-container">
                        <div className="chat-header">
                            <h2>ğŸ’¬ AI å¯¹è¯åŠ©æ‰‹</h2>
                            <Text type="secondary">æè¿°ä½ æƒ³è¦çš„è§†è§‰æ•ˆæœï¼ŒAI ä¸ºä½ ç”Ÿæˆä¸“ä¸šä¸»å›¾</Text>
                        </div>

                        <div className="chat-messages">
                            {chatHistory.length === 0 ? (
                                <Welcome
                                    variant="borderless"
                                    icon="âš¡"
                                    title="æ¬¢è¿ä½¿ç”¨ Xobi AI"
                                    description="æˆ‘æ˜¯ä½ çš„ä¸“å± AI è®¾è®¡åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ ç”Ÿæˆä¸“ä¸šçš„ç”µå•†ä¸»å›¾"
                                    extra={
                                        <Prompts
                                            title="ğŸ’¡ å¿«é€Ÿå¼€å§‹"
                                            items={promptSuggestions.map(p => ({
                                                key: p.key,
                                                label: `${p.icon} ${p.label}`,
                                                description: p.description
                                            }))}
                                            onItemClick={(info) => {
                                                const prompt = promptSuggestions.find(p => p.key === info.key);
                                                handlePromptClick(prompt);
                                            }}
                                        />
                                    }
                                />
                            ) : (
                                <>
                                    {chatHistory.map((msg, index) => (
                                        <div key={index} style={{ marginBottom: 16 }}>
                                            <Bubble
                                                placement={msg.role === 'user' ? 'end' : 'start'}
                                                content={msg.content}
                                                avatar={msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}
                                                variant={msg.role === 'user' ? 'filled' : 'outlined'}
                                                styles={{
                                                    content: {
                                                        background: msg.role === 'user'
                                                            ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                                            : '#f5f5f5',
                                                        color: msg.role === 'user' ? 'white' : '#333'
                                                    }
                                                }}
                                            />

                                            {/* AI æ¶ˆæ¯çš„å»ºè®®æŒ‰é’® */}
                                            {msg.role === 'assistant' && msg.suggestions && (
                                                <div style={{ marginTop: 12, marginLeft: 48 }}>
                                                    <Space wrap>
                                                        {msg.suggestions.map((suggestion, i) => (
                                                            <Button
                                                                key={i}
                                                                size="small"
                                                                type="dashed"
                                                                onClick={() => setInputValue(suggestion)}
                                                            >
                                                                {suggestion}
                                                            </Button>
                                                        ))}
                                                    </Space>
                                                </div>
                                            )}
                                        </div>
                                    ))}

                                    {loading && (
                                        <Bubble
                                            placement="start"
                                            avatar="ğŸ¤–"
                                            content={
                                                <div className="thinking-dots">
                                                    <span></span>
                                                    <span></span>
                                                    <span></span>
                                                </div>
                                            }
                                            variant="outlined"
                                        />
                                    )}
                                </>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        <div className="chat-input-area">
                            <Sender
                                value={inputValue}
                                onChange={setInputValue}
                                onSubmit={handleSend}
                                placeholder="æè¿°ä½ æƒ³è¦çš„è§†è§‰æ•ˆæœ..."
                                loading={loading}
                                prefix={
                                    <Attachments
                                        items={[
                                            refImage && { name: 'å‚è€ƒå›¾', url: refImage },
                                            prodImage && { name: 'äº§å“å›¾', url: prodImage }
                                        ].filter(Boolean)}
                                    />
                                }
                            />
                        </div>
                    </div>

                    {/* å³ä¾§ - é¢„è§ˆé¢æ¿ */}
                    <div className="preview-panel">
                        <div className="preview-header">
                            <h3>âœ¨ ç”Ÿæˆé¢„è§ˆ</h3>
                            <Text type="secondary">å®æ—¶æŸ¥çœ‹ç”Ÿæˆç»“æœ</Text>
                        </div>

                        {resultImage ? (
                            <div>
                                <img src={resultImage} alt="ç”Ÿæˆç»“æœ" className="preview-image" />
                                <Space direction="vertical" style={{ width: '100%' }}>
                                    <Button type="primary" block size="large">
                                        ğŸ’¾ ä¿å­˜å›¾ç‰‡
                                    </Button>
                                    <Button block size="large">
                                        ğŸ“¥ ä¸‹è½½åˆ°æœ¬åœ°
                                    </Button>
                                    <Button block size="large">
                                        âœï¸ ç»§ç»­ç¼–è¾‘
                                    </Button>
                                </Space>
                            </div>
                        ) : (
                            <Card
                                style={{
                                    textAlign: 'center',
                                    padding: 40,
                                    background: '#fafafa',
                                    border: '2px dashed #d9d9d9'
                                }}
                            >
                                <div style={{ fontSize: 48, marginBottom: 16 }}>ğŸ¨</div>
                                <Title level={5}>ç­‰å¾…ç”Ÿæˆ</Title>
                                <Paragraph type="secondary">
                                    ä¸Šä¼ å›¾ç‰‡å¹¶ä¸ AI å¯¹è¯åï¼Œç”Ÿæˆç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ
                                </Paragraph>
                            </Card>
                        )}

                        <div className="platform-selector">
                            <h4>ğŸ¯ ç›®æ ‡å¹³å°</h4>
                            <Select
                                value={selectedPlatform}
                                onChange={setSelectedPlatform}
                                style={{ width: '100%' }}
                                size="large"
                                options={[
                                    { value: 'amazon', label: 'ğŸ›’ Amazon' },
                                    { value: 'shopee', label: 'ğŸ›ï¸ Shopee' },
                                    { value: 'tiktok', label: 'ğŸµ TikTok' },
                                    { value: 'instagram', label: 'ğŸ“· Instagram' },
                                    { value: 'facebook', label: 'ğŸ‘¥ Facebook' }
                                ]}
                            />
                            <div style={{ marginTop: 12 }}>
                                <Space wrap>
                                    <Tag color="blue">1:1 æ¯”ä¾‹</Tag>
                                    <Tag color="green">2000Ã—2000</Tag>
                                    <Tag color="orange">ä¸»å›¾è§„æ ¼</Tag>
                                </Space>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // æ¸²æŸ“åº”ç”¨
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<XobiChatApp />);
    </script>
</body>

</html>
