<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç¼–è¾‘å™¨ - Xobi</title>

    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">

    <style>
        .editor-container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 1.5rem;
            height: calc(100vh - 80px);
            padding: 2rem;
        }

        .editor-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-l);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .editor-canvas {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-l);
            position: relative;
        }

        .editor-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: var(--radius-m);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .tool-section {
            margin-bottom: 2rem;
        }

        .tool-section h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tool-button {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--radius-m);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-button:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
            transform: translateX(4px);
        }

        .slider-control {
            margin-bottom: 1rem;
        }

        .slider-control label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .slider-control input[type="range"] {
            width: 100%;
            margin-bottom: 0.3rem;
        }

        .slider-value {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-align: right;
        }

        .platform-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .platform-btn {
            padding: 0.6rem;
            font-size: 0.85rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--radius-s);
            cursor: pointer;
            transition: all 0.2s;
        }

        .platform-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .history-item {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-s);
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-primary {
            flex: 1;
            padding: 0.8rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius-m);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            flex: 1;
            padding: 0.8rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--accent-color);
        }
    </style>
</head>

<body>
    <div class="editor-container">
        <!-- å·¦ä¾§å·¥å…·é¢æ¿ -->
        <div class="editor-panel">
            <div class="tool-section">
                <h3>åŸºç¡€å·¥å…·</h3>
                <button class="tool-button" onclick="openCropTool()">âœ‚ï¸ è£å‰ª</button>
                <button class="tool-button" onclick="openResizeTool()">ğŸ“ ç¼©æ”¾</button>
                <button class="tool-button" onclick="openRotateTool()">ğŸ”„ æ—‹è½¬</button>
                <button class="tool-button" onclick="openTextTool()">ğŸ“ æ·»åŠ æ–‡å­—</button>
            </div>

            <div class="tool-section">
                <h3>å›¾ç‰‡è°ƒæ•´</h3>

                <div class="slider-control">
                    <label>äº®åº¦</label>
                    <input type="range" min="50" max="200" value="100" id="brightness"
                        oninput="updateSlider('brightness', this.value)">
                    <div class="slider-value" id="brightness-value">100%</div>
                </div>

                <div class="slider-control">
                    <label>å¯¹æ¯”åº¦</label>
                    <input type="range" min="50" max="200" value="100" id="contrast"
                        oninput="updateSlider('contrast', this.value)">
                    <div class="slider-value" id="contrast-value">100%</div>
                </div>

                <div class="slider-control">
                    <label>é¥±å’Œåº¦</label>
                    <input type="range" min="50" max="200" value="100" id="saturation"
                        oninput="updateSlider('saturation', this.value)">
                    <div class="slider-value" id="saturation-value">100%</div>
                </div>

                <button class="tool-button" onclick="applyAdjustments()" style="background: var(--accent-color); color: white;">
                    åº”ç”¨è°ƒæ•´
                </button>
            </div>

            <div class="tool-section">
                <h3>æ»¤é•œ</h3>
                <button class="tool-button" onclick="applyFilter('sharpen')">é”åŒ–</button>
                <button class="tool-button" onclick="applyFilter('blur')">æ¨¡ç³Š</button>
                <button class="tool-button" onclick="applyFilter('smooth')">å¹³æ»‘</button>
                <button class="tool-button" onclick="applyFilter('edge_enhance')">è¾¹ç¼˜å¢å¼º</button>
            </div>
        </div>

        <!-- ä¸­é—´ç”»å¸ƒåŒºåŸŸ -->
        <div class="editor-canvas" id="canvas">
            <img src="" alt="ç¼–è¾‘å›¾ç‰‡" class="editor-image" id="editorImage" style="display: none;">
            <div id="placeholder" style="color: var(--text-tertiary);">
                è¯·ä» URL å‚æ•°åŠ è½½å›¾ç‰‡æˆ–ä¸Šä¼ å›¾ç‰‡
            </div>
        </div>

        <!-- å³ä¾§å±æ€§é¢æ¿ -->
        <div class="editor-panel">
            <div class="tool-section">
                <h3>å¹³å°ä¼˜åŒ–</h3>
                <div class="platform-grid">
                    <button class="platform-btn" onclick="optimizeForPlatform('amazon')">Amazon</button>
                    <button class="platform-btn" onclick="optimizeForPlatform('shopee')">Shopee</button>
                    <button class="platform-btn" onclick="optimizeForPlatform('tiktok')">TikTok</button>
                    <button class="platform-btn" onclick="optimizeForPlatform('instagram')">Instagram</button>
                </div>
            </div>

            <div class="tool-section">
                <h3>ç¼–è¾‘å†å²</h3>
                <div id="history">
                    <div class="history-item">åŸå§‹å›¾ç‰‡</div>
                </div>
            </div>

            <div class="tool-section">
                <h3>æ“ä½œ</h3>
                <div class="action-buttons">
                    <button class="btn-secondary" onclick="undoEdit()">æ’¤é”€</button>
                    <button class="btn-secondary" onclick="resetImage()">é‡ç½®</button>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" onclick="saveImage()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn-primary" onclick="downloadImage()">ğŸ“¥ ä¸‹è½½</button>
                </div>
            </div>

            <div class="tool-section">
                <h3>å›¾ç‰‡ä¿¡æ¯</h3>
                <div id="imageInfo" style="font-size: 0.85rem; color: var(--text-secondary);">
                    <p>å°ºå¯¸: <span id="imgSize">-</span></p>
                    <p>æ ¼å¼: <span id="imgFormat">-</span></p>
                    <p>å¤§å°: <span id="imgFileSize">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentImagePath = '';
        let editHistory = [];
        let currentHistoryIndex = -1;

        // ä» URL å‚æ•°åŠ è½½å›¾ç‰‡
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const imagePath = urlParams.get('image');

            if (imagePath) {
                loadImage(imagePath);
            }
        };

        function loadImage(path) {
            currentImagePath = path;
            const img = document.getElementById('editorImage');
            const placeholder = document.getElementById('placeholder');

            img.src = path;
            img.style.display = 'block';
            placeholder.style.display = 'none';

            img.onload = function () {
                updateImageInfo(img);
                addHistory('åŠ è½½å›¾ç‰‡');
            };
        }

        function updateImageInfo(img) {
            document.getElementById('imgSize').textContent = `${img.naturalWidth} Ã— ${img.naturalHeight}`;
            document.getElementById('imgFormat').textContent = 'PNG/JPEG';
        }

        function updateSlider(type, value) {
            document.getElementById(`${type}-value`).textContent = `${value}%`;
        }

        async function applyAdjustments() {
            const brightness = document.getElementById('brightness').value / 100;
            const contrast = document.getElementById('contrast').value / 100;
            const saturation = document.getElementById('saturation').value / 100;

            try {
                const response = await fetch('/api/editor/adjust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_path: currentImagePath,
                        brightness,
                        contrast,
                        saturation
                    })
                });

                const result = await response.json();
                if (result.success) {
                    loadImage(result.image_path);
                    addHistory('è°ƒæ•´å›¾ç‰‡å‚æ•°');
                }
            } catch (error) {
                console.error('åº”ç”¨è°ƒæ•´å¤±è´¥:', error);
                alert('è°ƒæ•´å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function applyFilter(filterType) {
            try {
                const response = await fetch('/api/editor/filter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_path: currentImagePath,
                        filter_type: filterType
                    })
                });

                const result = await response.json();
                if (result.success) {
                    loadImage(result.image_path);
                    addHistory(`åº”ç”¨æ»¤é•œ: ${filterType}`);
                }
            } catch (error) {
                console.error('åº”ç”¨æ»¤é•œå¤±è´¥:', error);
                alert('æ»¤é•œåº”ç”¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function optimizeForPlatform(platform) {
            // TODO: è°ƒç”¨å¹³å°ä¼˜åŒ– API
            alert(`ä¼˜åŒ–ä¸º ${platform} å¹³å°è§„æ ¼åŠŸèƒ½å¼€å‘ä¸­`);
        }

        function addHistory(action) {
            const historyDiv = document.getElementById('history');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.textContent = action;
            historyDiv.insertBefore(item, historyDiv.firstChild);

            editHistory.push(currentImagePath);
            currentHistoryIndex++;
        }

        function openCropTool() {
            alert('è£å‰ªå·¥å…·å¼€å‘ä¸­ï¼Œéœ€è¦å‰ç«¯ç”»å¸ƒäº¤äº’');
        }

        function openResizeTool() {
            const width = prompt('è¾“å…¥ç›®æ ‡å®½åº¦:');
            const height = prompt('è¾“å…¥ç›®æ ‡é«˜åº¦:');
            if (width && height) {
                resizeImage(parseInt(width), parseInt(height));
            }
        }

        function openRotateTool() {
            const angle = prompt('è¾“å…¥æ—‹è½¬è§’åº¦ï¼ˆæ­£æ•°ä¸ºé¡ºæ—¶é’ˆï¼‰:', '90');
            if (angle) {
                rotateImage(parseFloat(angle));
            }
        }

        function openTextTool() {
            alert('æ–‡å­—å·¥å…·å¼€å‘ä¸­ï¼Œéœ€è¦å‰ç«¯ç”»å¸ƒäº¤äº’');
        }

        async function resizeImage(width, height) {
            try {
                const response = await fetch('/api/editor/resize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_path: currentImagePath,
                        width,
                        height,
                        maintain_aspect_ratio: false
                    })
                });

                const result = await response.json();
                if (result.success) {
                    loadImage(result.image_path);
                    addHistory(`ç¼©æ”¾è‡³ ${width}Ã—${height}`);
                }
            } catch (error) {
                console.error('ç¼©æ”¾å¤±è´¥:', error);
                alert('ç¼©æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function rotateImage(angle) {
            try {
                const response = await fetch('/api/editor/rotate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_path: currentImagePath,
                        angle
                    })
                });

                const result = await response.json();
                if (result.success) {
                    loadImage(result.image_path);
                    addHistory(`æ—‹è½¬ ${angle}Â°`);
                }
            } catch (error) {
                console.error('æ—‹è½¬å¤±è´¥:', error);
                alert('æ—‹è½¬å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function undoEdit() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                loadImage(editHistory[currentHistoryIndex]);
            } else {
                alert('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ');
            }
        }

        function resetImage() {
            if (editHistory.length > 0) {
                loadImage(editHistory[0]);
                currentHistoryIndex = 0;
                addHistory('é‡ç½®å›¾ç‰‡');
            }
        }

        function saveImage() {
            alert('å›¾ç‰‡å·²è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.href = currentImagePath;
            link.download = 'edited_image.png';
            link.click();
        }
    </script>
</body>

</html>
