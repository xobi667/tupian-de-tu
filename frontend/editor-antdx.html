<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂõæÁâáÁºñËæëÂô® - Xobi</title>

    <!-- Ant Design CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Ant Design -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>

    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
        }

        #root {
            height: 100vh;
        }

        .editor-layout {
            height: 100vh;
        }

        .editor-sider {
            background: #fff;
            overflow-y: auto;
        }

        .editor-content {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            padding: 24px;
        }

        .editor-canvas {
            max-width: 100%;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .editor-image {
            max-width: 100%;
            max-height: calc(100vh - 100px);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .placeholder-content {
            text-align: center;
            color: #999;
        }

        .tool-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .platform-specs {
            margin-top: 12px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .image-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .image-info-item:last-child {
            border-bottom: none;
        }

        .image-info-label {
            color: #666;
            font-size: 14px;
        }

        .image-info-value {
            color: #262626;
            font-weight: 500;
            font-size: 14px;
        }

        .ant-btn-block {
            margin-bottom: 8px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #262626;
        }

        .slider-value {
            color: #1890ff;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { Layout, Button, Slider, Radio, Tag, List, Descriptions, Space, message, Divider, Card } = antd;
        const { Sider, Content } = Layout;
        const { useState, useEffect } = React;

        // Âπ≥Âè∞ËßÑÊ†ºÈÖçÁΩÆ
        const PLATFORM_SPECS = {
            amazon: { name: 'Amazon', width: 2000, height: 2000, ratio: '1:1', desc: '‰∏ªÂõæ2000x2000px' },
            shopee: { name: 'Shopee', width: 1024, height: 1024, ratio: '1:1', desc: '‰∏ªÂõæ1024x1024px' },
            tiktok: { name: 'TikTok', width: 1080, height: 1920, ratio: '9:16', desc: 'Á´ñÁâà1080x1920px' },
            instagram: { name: 'Instagram', width: 1080, height: 1080, ratio: '1:1', desc: 'Ê≠£ÊñπÂΩ¢1080x1080px' }
        };

        function EditorApp() {
            const [currentImagePath, setCurrentImagePath] = useState('');
            const [imageInfo, setImageInfo] = useState({ width: 0, height: 0, format: '-', size: '-' });
            const [editHistory, setEditHistory] = useState(['ÂéüÂßãÂõæÁâá']);
            const [selectedPlatform, setSelectedPlatform] = useState('');

            // ÊªëÂùóÁä∂ÊÄÅ
            const [brightness, setBrightness] = useState(100);
            const [contrast, setContrast] = useState(100);
            const [saturation, setSaturation] = useState(100);
            const [sharpness, setSharpness] = useState(100);

            useEffect(() => {
                // ‰ªé URL ÂèÇÊï∞Âä†ËΩΩÂõæÁâá
                const urlParams = new URLSearchParams(window.location.search);
                const imagePath = urlParams.get('image');
                if (imagePath) {
                    loadImage(imagePath);
                }
            }, []);

            const loadImage = (path) => {
                setCurrentImagePath(path);

                // ÂàõÂª∫ÂõæÁâáÂØπË±°Ëé∑ÂèñÂ∞∫ÂØ∏‰ø°ÊÅØ
                const img = new Image();
                img.onload = () => {
                    setImageInfo({
                        width: img.naturalWidth,
                        height: img.naturalHeight,
                        format: path.split('.').pop().toUpperCase(),
                        size: '-'
                    });
                };
                img.src = path;
            };

            const addHistory = (action) => {
                setEditHistory([action, ...editHistory]);
            };

            // Âü∫Á°ÄÂ∑•ÂÖ∑
            const handleCrop = () => {
                message.info('Ë£ÅÂâ™Â∑•ÂÖ∑ÂºÄÂèë‰∏≠,ÈúÄË¶ÅÂâçÁ´ØÁîªÂ∏É‰∫§‰∫í');
            };

            const handleResize = () => {
                const width = prompt('ËæìÂÖ•ÁõÆÊ†áÂÆΩÂ∫¶:');
                const height = prompt('ËæìÂÖ•ÁõÆÊ†áÈ´òÂ∫¶:');
                if (width && height) {
                    resizeImage(parseInt(width), parseInt(height));
                }
            };

            const handleRotate = () => {
                const angle = prompt('ËæìÂÖ•ÊóãËΩ¨ËßíÂ∫¶(Ê≠£Êï∞‰∏∫È°∫Êó∂Èíà):', '90');
                if (angle) {
                    rotateImage(parseFloat(angle));
                }
            };

            const handleAddText = () => {
                message.info('ÊñáÂ≠óÂ∑•ÂÖ∑ÂºÄÂèë‰∏≠,ÈúÄË¶ÅÂâçÁ´ØÁîªÂ∏É‰∫§‰∫í');
            };

            // API Ë∞ÉÁî®
            const applyAdjustments = async () => {
                if (!currentImagePath) {
                    message.warning('ËØ∑ÂÖàÂä†ËΩΩÂõæÁâá');
                    return;
                }

                const hide = message.loading('Â∫îÁî®Ë∞ÉÊï¥‰∏≠...', 0);
                try {
                    const response = await fetch('/api/editor/adjust', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_path: currentImagePath,
                            brightness: brightness / 100,
                            contrast: contrast / 100,
                            saturation: saturation / 100,
                            sharpness: sharpness / 100
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        loadImage(result.image_path);
                        addHistory('Ë∞ÉÊï¥ÂõæÁâáÂèÇÊï∞');
                        message.success('Ë∞ÉÊï¥ÊàêÂäü');
                    } else {
                        message.error('Ë∞ÉÊï¥Â§±Ë¥•: ' + (result.detail || 'Êú™Áü•ÈîôËØØ'));
                    }
                } catch (error) {
                    console.error('Â∫îÁî®Ë∞ÉÊï¥Â§±Ë¥•:', error);
                    message.error('Ë∞ÉÊï¥Â§±Ë¥•,ËØ∑ÈáçËØï');
                } finally {
                    hide();
                }
            };

            const applyFilter = async (filterType) => {
                if (!currentImagePath) {
                    message.warning('ËØ∑ÂÖàÂä†ËΩΩÂõæÁâá');
                    return;
                }

                const hide = message.loading(`Â∫îÁî®${filterType}Êª§Èïú‰∏≠...`, 0);
                try {
                    const response = await fetch('/api/editor/filter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_path: currentImagePath,
                            filter_type: filterType
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        loadImage(result.image_path);
                        addHistory(`Â∫îÁî®Êª§Èïú: ${filterType}`);
                        message.success('Êª§ÈïúÂ∫îÁî®ÊàêÂäü');
                    } else {
                        message.error('Êª§ÈïúÂ∫îÁî®Â§±Ë¥•: ' + (result.detail || 'Êú™Áü•ÈîôËØØ'));
                    }
                } catch (error) {
                    console.error('Â∫îÁî®Êª§ÈïúÂ§±Ë¥•:', error);
                    message.error('Êª§ÈïúÂ∫îÁî®Â§±Ë¥•,ËØ∑ÈáçËØï');
                } finally {
                    hide();
                }
            };

            const resizeImage = async (width, height) => {
                if (!currentImagePath) {
                    message.warning('ËØ∑ÂÖàÂä†ËΩΩÂõæÁâá');
                    return;
                }

                const hide = message.loading('Áº©Êîæ‰∏≠...', 0);
                try {
                    const response = await fetch('/api/editor/resize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_path: currentImagePath,
                            width,
                            height,
                            maintain_aspect_ratio: false
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        loadImage(result.image_path);
                        addHistory(`Áº©ÊîæËá≥ ${width}√ó${height}`);
                        message.success('Áº©ÊîæÊàêÂäü');
                    } else {
                        message.error('Áº©ÊîæÂ§±Ë¥•: ' + (result.detail || 'Êú™Áü•ÈîôËØØ'));
                    }
                } catch (error) {
                    console.error('Áº©ÊîæÂ§±Ë¥•:', error);
                    message.error('Áº©ÊîæÂ§±Ë¥•,ËØ∑ÈáçËØï');
                } finally {
                    hide();
                }
            };

            const rotateImage = async (angle) => {
                if (!currentImagePath) {
                    message.warning('ËØ∑ÂÖàÂä†ËΩΩÂõæÁâá');
                    return;
                }

                const hide = message.loading('ÊóãËΩ¨‰∏≠...', 0);
                try {
                    const response = await fetch('/api/editor/rotate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_path: currentImagePath,
                            angle
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        loadImage(result.image_path);
                        addHistory(`ÊóãËΩ¨ ${angle}¬∞`);
                        message.success('ÊóãËΩ¨ÊàêÂäü');
                    } else {
                        message.error('ÊóãËΩ¨Â§±Ë¥•: ' + (result.detail || 'Êú™Áü•ÈîôËØØ'));
                    }
                } catch (error) {
                    console.error('ÊóãËΩ¨Â§±Ë¥•:', error);
                    message.error('ÊóãËΩ¨Â§±Ë¥•,ËØ∑ÈáçËØï');
                } finally {
                    hide();
                }
            };

            const optimizeForPlatform = async (platform) => {
                if (!currentImagePath) {
                    message.warning('ËØ∑ÂÖàÂä†ËΩΩÂõæÁâá');
                    return;
                }

                const spec = PLATFORM_SPECS[platform];
                setSelectedPlatform(platform);

                // Ë∞ÉÁî®Áº©Êîæ API ‰ºòÂåñ‰∏∫Âπ≥Âè∞Â∞∫ÂØ∏
                await resizeImage(spec.width, spec.height);
            };

            const undoEdit = () => {
                message.info('Êí§ÈîÄÂäüËÉΩÂºÄÂèë‰∏≠');
            };

            const resetImage = () => {
                // ÈáçÁΩÆÊªëÂùó
                setBrightness(100);
                setContrast(100);
                setSaturation(100);
                setSharpness(100);
                setSelectedPlatform('');
                message.success('Â∑≤ÈáçÁΩÆÊâÄÊúâË∞ÉÊï¥');
            };

            const saveImage = () => {
                message.success('ÂõæÁâáÂ∑≤Ëá™Âä®‰øùÂ≠òÂà∞ÊúçÂä°Âô®');
            };

            const downloadImage = () => {
                if (!currentImagePath) {
                    message.warning('ËØ∑ÂÖàÂä†ËΩΩÂõæÁâá');
                    return;
                }

                const link = document.createElement('a');
                link.href = currentImagePath;
                link.download = 'edited_image_' + Date.now() + '.png';
                link.click();
                message.success('ÂºÄÂßã‰∏ãËΩΩÂõæÁâá');
            };

            return (
                <Layout className="editor-layout">
                    {/* Â∑¶‰æßÂ∑•ÂÖ∑Èù¢Êùø */}
                    <Sider width={300} className="editor-sider" style={{ padding: '24px 16px' }}>
                        <div className="tool-section">
                            <div className="section-title">Âü∫Á°ÄÂ∑•ÂÖ∑</div>
                            <Button block onClick={handleCrop} style={{ marginBottom: 8 }}>
                                Ë£ÅÂâ™
                            </Button>
                            <Button block onClick={handleResize} style={{ marginBottom: 8 }}>
                                Áº©Êîæ
                            </Button>
                            <Button block onClick={handleRotate} style={{ marginBottom: 8 }}>
                                ÊóãËΩ¨
                            </Button>
                            <Button block onClick={handleAddText} style={{ marginBottom: 8 }}>
                                Ê∑ªÂä†ÊñáÂ≠ó
                            </Button>
                        </div>

                        <Divider />

                        <div className="tool-section">
                            <div className="section-title">ÂõæÁâáË∞ÉÊï¥</div>

                            <div style={{ marginBottom: 16 }}>
                                <div className="slider-label">
                                    <span>‰∫ÆÂ∫¶</span>
                                    <span className="slider-value">{brightness}%</span>
                                </div>
                                <Slider
                                    min={50}
                                    max={200}
                                    value={brightness}
                                    onChange={setBrightness}
                                />
                            </div>

                            <div style={{ marginBottom: 16 }}>
                                <div className="slider-label">
                                    <span>ÂØπÊØîÂ∫¶</span>
                                    <span className="slider-value">{contrast}%</span>
                                </div>
                                <Slider
                                    min={50}
                                    max={200}
                                    value={contrast}
                                    onChange={setContrast}
                                />
                            </div>

                            <div style={{ marginBottom: 16 }}>
                                <div className="slider-label">
                                    <span>È•±ÂíåÂ∫¶</span>
                                    <span className="slider-value">{saturation}%</span>
                                </div>
                                <Slider
                                    min={50}
                                    max={200}
                                    value={saturation}
                                    onChange={setSaturation}
                                />
                            </div>

                            <div style={{ marginBottom: 16 }}>
                                <div className="slider-label">
                                    <span>ÈîêÂ∫¶</span>
                                    <span className="slider-value">{sharpness}%</span>
                                </div>
                                <Slider
                                    min={50}
                                    max={200}
                                    value={sharpness}
                                    onChange={setSharpness}
                                />
                            </div>

                            <Button type="primary" block onClick={applyAdjustments}>
                                Â∫îÁî®Ë∞ÉÊï¥
                            </Button>
                        </div>

                        <Divider />

                        <div className="tool-section">
                            <div className="section-title">Êª§Èïú</div>
                            <Button block onClick={() => applyFilter('sharpen')} style={{ marginBottom: 8 }}>
                                ÈîêÂåñ
                            </Button>
                            <Button block onClick={() => applyFilter('blur')} style={{ marginBottom: 8 }}>
                                Ê®°Á≥ä
                            </Button>
                            <Button block onClick={() => applyFilter('smooth')} style={{ marginBottom: 8 }}>
                                Âπ≥Êªë
                            </Button>
                            <Button block onClick={() => applyFilter('edge_enhance')} style={{ marginBottom: 8 }}>
                                ËæπÁºòÂ¢ûÂº∫
                            </Button>
                        </div>
                    </Sider>

                    {/* ‰∏≠Èó¥ÁîªÂ∏ÉÂå∫Âüü */}
                    <Content className="editor-content">
                        <div className="editor-canvas">
                            {currentImagePath ? (
                                <img
                                    src={currentImagePath}
                                    alt="ÁºñËæëÂõæÁâá"
                                    className="editor-image"
                                />
                            ) : (
                                <div className="placeholder-content">
                                    <div style={{ fontSize: 48, marginBottom: 16 }}>üì∏</div>
                                    <div style={{ fontSize: 16 }}>ËØ∑‰ªé URL ÂèÇÊï∞Âä†ËΩΩÂõæÁâá</div>
                                    <div style={{ fontSize: 14, marginTop: 8, color: '#bbb' }}>
                                        ‰æãÂ¶Ç: ?image=/outputs/xxx.png
                                    </div>
                                </div>
                            )}
                        </div>
                    </Content>

                    {/* Âè≥‰æßÂ±ûÊÄßÈù¢Êùø */}
                    <Sider width={350} className="editor-sider" style={{ padding: '24px 16px' }}>
                        <div className="tool-section">
                            <div className="section-title">Âπ≥Âè∞‰ºòÂåñ</div>
                            <Radio.Group
                                value={selectedPlatform}
                                onChange={(e) => optimizeForPlatform(e.target.value)}
                                style={{ width: '100%' }}
                            >
                                <Space direction="vertical" style={{ width: '100%' }}>
                                    <Radio.Button value="amazon" style={{ width: '100%', textAlign: 'center' }}>
                                        Amazon
                                    </Radio.Button>
                                    <Radio.Button value="shopee" style={{ width: '100%', textAlign: 'center' }}>
                                        Shopee
                                    </Radio.Button>
                                    <Radio.Button value="tiktok" style={{ width: '100%', textAlign: 'center' }}>
                                        TikTok
                                    </Radio.Button>
                                    <Radio.Button value="instagram" style={{ width: '100%', textAlign: 'center' }}>
                                        Instagram
                                    </Radio.Button>
                                </Space>
                            </Radio.Group>

                            {selectedPlatform && (
                                <div className="platform-specs">
                                    <Tag color="blue">{PLATFORM_SPECS[selectedPlatform].ratio}</Tag>
                                    <Tag>{PLATFORM_SPECS[selectedPlatform].desc}</Tag>
                                </div>
                            )}
                        </div>

                        <Divider />

                        <div className="tool-section">
                            <div className="section-title">ÁºñËæëÂéÜÂè≤</div>
                            <div className="history-list">
                                <List
                                    size="small"
                                    dataSource={editHistory}
                                    renderItem={(item, index) => (
                                        <List.Item>
                                            <span style={{ fontSize: 12, color: '#999', marginRight: 8 }}>
                                                {index + 1}.
                                            </span>
                                            <span style={{ fontSize: 14 }}>{item}</span>
                                        </List.Item>
                                    )}
                                />
                            </div>
                        </div>

                        <Divider />

                        <div className="tool-section">
                            <div className="section-title">Êìç‰Ωú</div>
                            <Space direction="vertical" style={{ width: '100%' }}>
                                <Space style={{ width: '100%' }}>
                                    <Button onClick={undoEdit} style={{ flex: 1 }}>Êí§ÈîÄ</Button>
                                    <Button onClick={resetImage} style={{ flex: 1 }}>ÈáçÁΩÆ</Button>
                                </Space>
                                <Space style={{ width: '100%' }}>
                                    <Button type="primary" onClick={saveImage} style={{ flex: 1 }}>
                                        ‰øùÂ≠ò
                                    </Button>
                                    <Button type="primary" onClick={downloadImage} style={{ flex: 1 }}>
                                        ‰∏ãËΩΩ
                                    </Button>
                                </Space>
                            </Space>
                        </div>

                        <Divider />

                        <div className="tool-section">
                            <div className="section-title">ÂõæÁâá‰ø°ÊÅØ</div>
                            <div>
                                <div className="image-info-item">
                                    <span className="image-info-label">Â∞∫ÂØ∏</span>
                                    <span className="image-info-value">
                                        {imageInfo.width > 0 ? `${imageInfo.width} √ó ${imageInfo.height}` : '-'}
                                    </span>
                                </div>
                                <div className="image-info-item">
                                    <span className="image-info-label">Ê†ºÂºè</span>
                                    <span className="image-info-value">{imageInfo.format}</span>
                                </div>
                                <div className="image-info-item">
                                    <span className="image-info-label">Â§ßÂ∞è</span>
                                    <span className="image-info-value">{imageInfo.size}</span>
                                </div>
                            </div>
                        </div>
                    </Sider>
                </Layout>
            );
        }

        // Ê∏≤ÊüìÂ∫îÁî®
        ReactDOM.render(<EditorApp />, document.getElementById('root'));
    </script>
</body>

</html>
